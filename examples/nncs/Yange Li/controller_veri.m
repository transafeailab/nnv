% /* An example of verifying a continuous nonlinear NNCS */
% / FFNN controller
% [weights, bias] = parameter();
weights = {[-0.25914913415908813, -0.9550679922103882, -0.9743961095809937, 0.15304039418697357; 0.00014224844926502556, -0.01186179555952549, -0.0007189857424236834, 0.001198246143758297; -0.004347098059952259, -0.005769804585725069, -0.0688423439860344, -0.04939489811658859; 0.10746234655380249, -0.331727534532547, -0.19372808933258057, -0.15208137035369873; -0.9440452456474304, -0.651612401008606, 1.1643222570419312, 1.8579879999160767; -0.3560789227485657, -0.4499610662460327, 1.7980157136917114, 0.1535687893629074; 0.0001553955371491611, 1.744266955938656e-05, -1.9648176419195806e-08, 7.525121327489614e-05; -0.31834298372268677, -0.5938663482666016, -0.8661438822746277, 0.10747510194778442; -0.27864426374435425, -1.705081820487976, 1.2512155771255493, -1.5129765272140503; 0.004282516427338123, -0.012280039489269257, -0.006005698814988136, -0.007760784588754177; 0.006170459557324648, -0.013106869533658028, -0.0014610567595809698, 0.00039743309025652707; 0.5562489032745361, -1.1749764680862427, 0.588590681552887, -0.3528785705566406; 0.23041723668575287, -0.05457400530576706, -1.2814266681671143, -1.5654067993164062; 1.6140046119689941, -0.008506322279572487, -2.4568865299224854, -1.8981412649154663; 0.00677833566442132, 3.116006337222643e-05, -0.011086818762123585, -0.008135601878166199; -0.5735451579093933, -0.12275481224060059, 0.782662034034729, 2.2364065647125244; -0.004703983664512634, -0.0012763101840391755, -0.0006196299218572676, 0.0016975430771708488; 0.9239213466644287, -0.2344922125339508, -1.1568409204483032, -0.9962942004203796; -0.18527239561080933, -0.7131596207618713, 0.83552086353302, 0.672856330871582; 0.02358049713075161, -0.29712003469467163, -0.019387220963835716, -0.2223956286907196; -0.2970605790615082, -1.3781743049621582, -1.011372685432434, -0.01573937200009823; -0.001279656426049769, -0.05520132556557655, -0.050413861870765686, -0.014535877853631973; -1.1010725498199463, -1.0628798007965088, -0.03737836703658104, 2.750422477722168; -1.4476464986801147, -1.5848093032836914, -2.0731537342071533, 3.055105447769165; 0.1114262267947197, -0.493679016828537, -0.722576379776001, 0.26788240671157837; 0.0008384839748032391, -0.048057351261377335, -0.01640797033905983, -0.000330485578160733; 0.0010759223951026797, -0.005273756105452776, -0.0030505505856126547, 0.0019271644996479154; -0.04554876312613487, -0.53367018699646, 0.3640318810939789, -0.03292345255613327; 0.004894831217825413, -0.027401285246014595, 0.014014686457812786, 0.041773755103349686; 0.8650987148284912, -0.17266398668289185, -0.9890796542167664, -0.7229344844818115; 0.45547428727149963, -0.46167612075805664, -0.19562479853630066, -0.5466586947441101; -0.3841467499732971, -0.7151117324829102, 3.4225711822509766, 0.7037035822868347; 0.569810688495636, -0.8909865617752075, -0.04241083934903145, -0.9801920652389526; -0.4805344343185425, -1.819858193397522, 0.7539308667182922, 2.474599599838257; 0.9646510481834412, -0.8753735423088074, -1.439294457435608, -2.1716468334198; -2.0685863494873047, 0.009315617382526398, 0.6225791573524475, -0.204009011387825; 0.012388995848596096, -0.016364218667149544, -0.01198633760213852, 0.0006292995531111956; -1.248201847076416, -0.4820033013820648, -0.9331139326095581, 0.019885698333382607; -0.6761241555213928, -1.696671485900879, -0.5858030915260315, 0.639920711517334; 0.37940317392349243, -1.6123321056365967, -0.5497967004776001, 1.5260565280914307; -0.027146868407726288, -0.4060305655002594, -0.1037752777338028, -0.09915680438280106; 2.7155086994171143, -1.8931281566619873, -2.3329529762268066, -3.1072475910186768; -2.9154052734375, 0.002476467750966549, -5.1117634773254395, 2.618016481399536; 2.644646644592285, 2.3446948528289795, 0.3943007290363312, 1.3585816621780396; 0.09947599470615387, -0.8047757148742676, -0.4120505452156067, -0.6155749559402466; 0.18078358471393585, -0.22765815258026123, -0.10940985381603241, 0.13213060796260834; 2.022616386413574, -0.24850843846797943, -2.332244396209717, -2.735748291015625; 0.01790642738342285, -0.04735492914915085, -0.037148915231227875, -0.014830498956143856; 0.5367540717124939, -1.8946223258972168, 1.779021978378296, 1.7513505220413208; -1.5888924598693848, -0.7603387236595154, 1.3091301918029785, -0.3230612874031067; 0.014879670925438404, 0.009251425042748451, -0.06691144406795502, 0.06994055211544037; -0.0800071731209755, -1.2031699419021606, 0.8826671838760376, -0.048836059868335724; 0.14506882429122925, -1.9574342966079712, -0.047352634370326996, 0.5511680245399475; 0.33097609877586365, -0.9297440648078918, -1.2440282106399536, 0.18422533571720123; 0.5072558522224426, -0.4539947807788849, 0.6792025566101074, -0.9155694246292114; 0.001738026854582131, 0.005179057363420725, -0.00329178711399436, -0.0032011873554438353; -2.5424857139587402, -1.5445863008499146, 1.9644855260849, -2.5640134811401367; 0.6019788980484009, 0.002921846229583025, -0.3960573971271515, -1.7264474630355835; -0.1509590744972229, 0.19268186390399933, -0.5851309895515442, 1.4791368246078491; 0.3169529139995575, -0.7161672711372375, -0.1660277545452118, -0.32516634464263916; 2.1060750484466553, -0.12606650590896606, -3.038050651550293, -1.9718431234359741; 0.04337848722934723, -0.018492957577109337, -0.23281194269657135, -0.02089483104646206; -0.799683690071106, -1.7920949459075928, 0.11085817962884903, 0.22755713760852814; -0.6941161155700684, -0.38661569356918335, -0.48115482926368713, 0.8919106125831604; -1.3620165586471558, -0.1477973759174347, -1.8768479824066162, 3.182664394378662; 0.02966964803636074, -0.0064841751009225845, -0.005986818112432957, -0.013167867437005043; 0.7208582758903503, -0.6812278032302856, 1.3242112398147583, -1.3989206552505493; -0.8131937980651855, -1.3542176485061646, -0.039300400763750076, -0.18161612749099731; 1.8738234043121338, -2.3567302227020264, -2.2432844638824463, -3.493976593017578; -2.9186251163482666, -1.3829056024551392, -3.8692917823791504, 3.4783742427825928; 0.21524137258529663, -0.27544525265693665, 0.6664068698883057, -0.40867993235588074; -0.0008066677837632596, -0.01359750796109438, -0.0035713219549506903, -0.04029504954814911; 4.583110809326172, -0.24194781482219696, 3.203892230987549, 2.708672046661377; -0.08973327279090881, -0.8643320798873901, -0.5340062379837036, 0.0811377763748169; 0.5888363718986511, -0.34410637617111206, -0.1933172345161438, -0.9741091728210449; -0.3139362633228302, -1.417106032371521, 0.34525278210639954, 0.38457080721855164; -0.5962704420089722, -0.6011464595794678, -0.5945450067520142, 1.4573924541473389; 0.24805720150470734, -0.4461272060871124, -0.3792878985404968, -0.262722373008728; -0.0844070240855217, -0.19904127717018127, -0.10975050181150436, 0.20354405045509338; -0.038426630198955536, -0.05442594364285469, 0.05772294104099274, -0.034419964998960495; 0.39608174562454224, 0.19793738424777985, -1.1657233238220215, -1.2392255067825317; 0.6951964497566223, -1.7691309452056885, -0.298101007938385, -2.552281618118286; -0.0016169926384463906, -0.008732599206268787, 0.007450861390680075, 0.001316918176598847; -0.8626366853713989, 0.31352612376213074, -1.950385332107544, 1.0328919887542725; -0.021730788052082062, -1.281612515449524, 0.9734438061714172, -0.025664523243904114; 0.05273063853383064, -0.5021213293075562, 1.7775884866714478, -0.9217365980148315; 0.008243699558079243, -0.7767471075057983, 3.2556087970733643, 0.8327837586402893; 1.7780989408493042, -3.318612813949585, -1.4876201152801514, 4.898273468017578; 0.00918278843164444, -1.926109790802002, 1.9552314281463623, -0.09524877369403839; 0.028474699705839157, -0.10119910538196564, -0.10811657458543777, -0.16541844606399536; 1.0950825214385986, 0.2553453743457794, 0.7024517059326172, -2.8132739067077637; 0.02713032253086567, -5.308245658874512, -9.66911506652832, 0.09277326613664627; 0.23802855610847473, -0.3657495975494385, 1.9539694786071777, -0.770351767539978; -1.9340463876724243, -4.093270778656006, -0.9682491421699524, -5.358004093170166; 1.0957260131835938, -1.2852492332458496, 0.2826935946941376, 1.1614941358566284; 1.1848958730697632, -0.024897560477256775, -0.9070846438407898, -0.26146963238716125; 0.365994930267334, -0.9320864081382751, 0.7339659333229065, -0.338096022605896; -2.896529197692871, 4.186716556549072, 2.0014560222625732, -1.3931684494018555; -0.14597652852535248, -0.22119474411010742, -0.2451748102903366, -0.19480983912944794; -0.5577452182769775, 0.21583189070224762, -1.310750126838684, 0.5315818190574646] [0.059667106717824936, 5.41188827085648e-09, -2.0395032349880364e-25, 0.006891004275530577, -1.7174906730651855, 0.7192893028259277, -7.700506898800086e-09, 0.02802789956331253, -2.658024549484253, 0.0009225503890775144, 7.382447620329913e-06, -0.6968740224838257, -0.4172351658344269, -4.38450813293457, -0.01895713247358799, -1.2235569953918457, -0.0004348177753854543, -2.2741963863372803, -1.2078797817230225, -1.2914812941744458e-05, 0.04170028120279312, 5.00034668769042e-22, -2.979504108428955, -4.506288051605225, -0.1472495049238205, 0.0003974894934799522, 8.038739118809701e-10, -0.7840229868888855, -0.000531126104760915, -1.9953792095184326, -0.5965483784675598, -0.8560490608215332, -1.5507892370224, -2.5513880252838135, -2.766097068786621, 4.516079425811768, -6.850737997314382e-40, -0.3385333716869354, -0.6448661684989929, 2.2530033588409424, -0.10949963331222534, -6.114330291748047, -7.344344615936279, 10.681757926940918, -0.28331929445266724, 0.0015949385706335306, -4.816651344299316, -6.487782684416743e-06, -3.847923994064331, 0.9098162055015564, 0.04491351917386055, -1.7860184907913208, -0.2641426920890808, -0.00037062319461256266, -0.6023029685020447, -2.087031673119295e-26, 8.682549476623535, -1.3832846879959106, -0.40860670804977417, -0.29961729049682617, -5.293360710144043, -6.60400910419412e-05, 2.8965067863464355, -1.1175583600997925, -1.4113376140594482, -8.616055856691673e-05, -1.4458144903182983, 1.00774347782135, -5.442594051361084, -6.7710442543029785, -0.08969858288764954, -0.0002699165779631585, 10.92661190032959, 0.0013240431435406208, -0.8046805262565613, -1.5404713153839111, -1.5227351188659668, 0.023713139817118645, -0.013504325412213802, 0.00884941779077053, -0.3851815462112427, -3.0108377933502197, 0.02727985940873623, -2.6308138370513916, -1.992942452430725, -0.8146160244941711, -0.8091520071029663, 8.548188209533691, -3.0472192764282227, 0.07251773774623871, -0.13245657086372375, 11.55003833770752, -0.9537220597267151, 9.700539588928223, 2.0411465167999268, -1.5809853076934814, -0.5194847583770752, 12.685487747192383, -0.0003869103966280818, -1.668338418006897; -0.9515694975852966, 0.38982686400413513, -0.37049147486686707, -0.11142278462648392, 1.4559687376022339, 0.2428542673587799, -0.28325632214546204, -0.12323881685733795, 0.35810405015945435, -0.003988849464803934, -0.034817878156900406, -0.1409415900707245, -0.22517141699790955, -0.2195315808057785, -0.0012847933685407043, 0.9990382790565491, -0.5469397902488708, -0.014563263393938541, -0.5783306360244751, -0.9026517868041992, 0.4040297269821167, 0.010812933556735516, -1.346327304840088, 0.11305298656225204, 0.07366114854812622, -0.397892564535141, 0.05937901511788368, -0.056289780884981155, 0.49849560856819153, 0.034565988928079605, -0.1772657036781311, 2.6378750801086426, 0.17822884023189545, -0.37700197100639343, 1.242488980293274, -0.39942264556884766, 0.06568590551614761, -0.2508999705314636, -0.1553160399198532, 0.15892355144023895, -0.052098192274570465, -0.12070591747760773, -0.02638969197869301, 0.07340304553508759, 0.7548878788948059, -0.19793982803821564, -0.3303452730178833, -0.015840306878089905, -0.2233140617609024, 0.5679418444633484, -0.1334400624036789, -0.13457056879997253, 0.22525130212306976, 0.039481960237026215, -0.7291091680526733, -0.018334941938519478, -0.015566513873636723, -0.7757758498191833, 0.2393137663602829, -0.160378560423851, 0.021061060950160027, 0.5249343514442444, -0.02734709344804287, 0.34298646450042725, 0.289373517036438, -0.34925222396850586, -0.8230971693992615, -0.3447085916996002, 0.0867052972316742, 0.05414016172289848, 0.2988634407520294, -0.066073477268219, -0.0377669632434845, 0.5049451589584351, 0.09610528498888016, 0.02022428810596466, -0.8372406959533691, -0.017832770943641663, -0.1102246567606926, 0.058923255652189255, -0.24086324870586395, 0.20877911150455475, 0.00929577462375164, 0.02313174679875374, -0.10283058881759644, 1.1183842420578003, -3.022620677947998, -0.047395482659339905, 0.5019148588180542, -0.026202350854873657, -0.3761281371116638, -0.018862616270780563, -0.9244184494018555, 0.004792810417711735, 0.21971598267555237, 0.20918145775794983, -0.9305237531661987, 0.030789028853178024, 0.038503438234329224, -0.0663035586476326] };
bias = {[-1.2795182466506958; -0.02138945460319519; -0.1459251195192337; -0.6386444568634033; -2.4057505130767822; -2.240610361099243; -0.000634683936368674; -1.5036466121673584; -0.9134546518325806; -0.028301706537604332; -0.05500006675720215; -2.5011003017425537; -1.579890251159668; -2.781062126159668; -0.011609320528805256; -1.9003030061721802; -0.01868780516088009; -1.37943696975708; -1.3425533771514893; -0.8706942200660706; -2.2016513347625732; -0.13371093571186066; -2.1733603477478027; -1.513527512550354; -0.7510976195335388; -0.07826456427574158; -0.024095818400382996; -0.6800315976142883; -0.13779549300670624; -1.1523895263671875; -0.878553569316864; -3.199319839477539; -1.0372869968414307; -1.4860601425170898; -1.7765562534332275; -1.404488444328308; -0.09390750527381897; -0.4057934284210205; -0.9363456964492798; -1.8080071210861206; -0.3074658513069153; -3.472982406616211; -3.4216268062591553; -0.12860530614852905; -1.7246224880218506; -1.0120328664779663; -3.1788318157196045; -0.12397681176662445; -0.7115346789360046; -0.05826714634895325; -0.16074934601783752; -1.6015913486480713; -1.2196124792099; -1.6594452857971191; -1.7280449867248535; -0.036000847816467285; -3.3659744262695312; -1.8679914474487305; -1.1443333625793457; -1.230041742324829; -3.0872395038604736; -0.513090193271637; -0.23693478107452393; -1.4130560159683228; -0.9825522899627686; -0.12090850621461868; -2.254511833190918; -0.8548303246498108; -1.5248993635177612; -2.6804211139678955; -1.9912532567977905; -0.0645717903971672; -3.391578197479248; -1.4408409595489502; -0.440264493227005; -1.747381567955017; -1.289540410041809; -0.954892635345459; -0.330415815114975; -0.25828006863594055; -0.28168073296546936; -1.1106722354888916; -0.024341564625501633; -1.3979582786560059; -1.7340713739395142; -1.838919997215271; -3.0431106090545654; -2.5306856632232666; -3.1227893829345703; -0.18076686561107635; 1.1522377729415894; 1.3812702894210815; -1.7959771156311035; -3.785132646560669; -1.9384827613830566; -0.5403380393981934; -2.2346842288970947; -0.19748952984809875; -0.903797447681427; -0.7725717425346375];[0.916973888874054; 0.1864968240261078];};

n = 2;
Layers = [];

% % add a dummy reference input 
% L = LayerS([1,0,0,0,0;0,1,0,0,0;0,0,1,0,0;0,0,0,1,0],[0;0;0;0],'purelin');
% Layers = [Layers L];


for i=1:n - 1
    L = LayerS(weights{1, i}, bias{i, 1}, 'poslin');
    Layers = [Layers L];
end
L = LayerS(weights{1, n}, bias{n, 1}, 'purelin');
Layers = [Layers L];

% clamp the output 0<vr<100 and -pi/3<delta<pi/3
L = LayerS([1 0;0 1],[0;pi/3],'poslin');
Layers = [Layers L];
L = LayerS([-1 0;0 -1],[100;2*pi/3],'poslin');
Layers = [Layers L];
L = LayerS([-1 0; 0 -1],[100;pi/3],'purelin');
Layers = [Layers L];

controller = FFNNS(Layers); 
% /* car model
Tr = 0.001; % reachability time step for the plant
Tc = 0.01; % control period of the plant
% output matrix
C = [-1 0 0 1 0 0 0 0;0 -1 0 0 1 0 0 0; 0 0 0 0 0 0 1 0; 0 0 0 0 0 0 0 1]; % output matrix
car = NonLinearODE(8, 2, @car_dynamics_modify, Tr, Tc, C);
% /* system
ncs = NonlinearNNCS(controller, car); 

% /* ranges of initial set of states of the plant
lb = [-0.1; -0.6; pi/2; 0; 0; pi/2;1;0];
ub = [-0.08; -0.58; pi/2; 0; 0; pi/2;1;0];
% ub = [0.1; -0.4; pi/2; 0; 0; pi/2;1;0];

% /* reachability parameters
reachPRM.init_set = Star(lb, ub);
reachPRM.ref_input = [];
reachPRM.numSteps = 2;
reachPRM.reachMethod = 'approx-star';
reachPRM.numCores = 4;
% /* usafe region: x1 - x4 <= 1.4 * v_ego + 10
unsafe_mat = [1 0 0 0 0 0 0 0];
unsafe_vec = -1000;
U = HalfSpace(unsafe_mat, unsafe_vec);
%U = HalfSpace([-1 0 0 0 0 0], -20);
% /* verify the system
[safe, counterExamples, verifyTime] = ncs.verify(reachPRM, U);

% /* simulate the system
[simTrace, controlTrace] = ncs.evaluate(Tc, 2, lb, []);

%% plot 2d output sets
figure; 
map_mat = [1 0 0 0 0 0 0 0; 0 1 0 0 0 0 0 0];
map_vec = [];
ncs.plotOutputReachSets('blue', map_mat, map_vec);
sim_y = map_mat*simTrace;
hold on;
plot(sim_y(1, :), sim_y(2, :), '--*');
title('y vs x');

%% plot 1d output sets
figure;
map_mat = [1 0 0 0 0 0 0 0];
map_vec = [];
ncs.plotOutputReachSets('blue', map_mat, map_vec);
title('x position vs time')

figure;
map_mat = [0 1 0 0 0 0 0 0];
map_vec = [];
ncs.plotOutputReachSets('blue', map_mat, map_vec);
title('y position vs time')